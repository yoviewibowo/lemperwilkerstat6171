<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LEMPER WILKERSTAT 6171</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="bg-white shadow p-4">
    <h1 class="text-2xl font-bold">LEMPER WILKERSTAT 6171</h1>
    <div class="mt-1 text-sm text-gray-500">
      Dashboard Laporan Evaluasi & Monitoring Pemetaan Wilayah Kerja Statistik BPS Kota Pontianak
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 space-y-6">
    <!-- Filters -->
    <section class="flex flex-wrap gap-2">
      <select id="filterPML" class="p-2 border rounded">
        <option value="ALL">Semua PML</option>
      </select>
      <input id="searchPPL" type="text" placeholder="Cari PPL..." class="p-2 border rounded flex-1"/>
    </section>

    <!-- KPI Cards -->
    <section id="kpi" class="grid grid-cols-1 md:grid-cols-4 gap-4"></section>

    <!-- Chart -->
    <section class="bg-white border rounded p-4 shadow">
      <h2 class="font-semibold mb-2">Rangkuman per PML</h2>
      <canvas id="pmlChart" height="100"></canvas>
    </section>

    <!-- Table -->
    <section class="bg-white border rounded p-4 shadow overflow-auto">
      <table class="min-w-full text-sm" id="dataTable">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 text-left">PML</th>
            <th class="p-2 text-left">PPL</th>
            <th class="p-2 text-right">SLSMASTER</th>
            <th class="p-2 text-right">PROJECT</th>
            <th class="p-2 text-right">%PROJECT</th>
            <th class="p-2 text-right">FINALISASI</th>
            <th class="p-2 text-right">%FINALISASI</th>
            <th class="p-2 text-right">LANDMARK</th>
            <th class="p-2 text-right">BATASSLS</th>
            <th class="p-2 text-right">BATASSEGMEN</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/1aOhkt2XboN2z0UBJDoka3nQIxDm_mFgaEdDvQFWtg5o/export?format=csv&gid=2134444139";
    let allData = [];
    let chart;

    function parseNumber(v) {
      if (!v) return 0;
      return parseFloat(String(v).replace(/%/g, "").replace(",", ".").trim()) || 0;
    }

    function fetchData() {
      fetch(CSV_URL)
        .then(res => res.text())
        .then(csv => {
          const rows = csv.split("\n").map(r => r.split(","));
          const headers = rows.shift().map(h => h.trim());
          allData = rows.filter(r => r.length >= headers.length).map(cols => {
            const obj = {};
            headers.forEach((h, i) => obj[h] = cols[i] ? cols[i].trim() : "");
            obj.SLSMASTER = parseNumber(obj.SLSMASTER);
            obj.PROJECT = parseNumber(obj.PROJECT);
            obj["%PROJECT"] = parseNumber(obj["%PROJECT"]);
            obj.FINALISASIPROJECT = parseNumber(obj.FINALISASIPROJECT);
            obj["%FINALISASIPROJECT"] = parseNumber(obj["%FINALISASIPROJECT"]);
            obj.LANDMARK = obj.LANDMARK; // biarkan apa adanya (string/angka asli)
            obj.BATASSLS = parseNumber(obj.BATASSLS);
            obj.BATASSEGMEN = parseNumber(obj.BATASSEGMEN);
            return obj;
          });
          renderDashboard();
        });
    }

    function renderDashboard() {
      const pmlSet = Array.from(new Set(allData.map(d => d.PML).filter(Boolean)));
      const filterSelect = document.getElementById("filterPML");
      filterSelect.innerHTML = '<option value="ALL">Semua PML</option>' + pmlSet.map(p => `<option value="${p}">${p}</option>`).join("");
      filterSelect.onchange = updateView;
      document.getElementById("searchPPL").oninput = updateView;
      updateView();
    }

    function updateView() {
      const filterPML = document.getElementById("filterPML").value;
      const searchPPL = document.getElementById("searchPPL").value.toLowerCase();
      const filtered = allData.filter(d =>
        (filterPML === "ALL" || d.PML === filterPML) &&
        (!searchPPL || d.PPL.toLowerCase().includes(searchPPL))
      );
      renderKPI(filtered);
      renderChart(filtered);
      renderTable(filtered);
    }

    function renderKPI(data) {
      const totalSLS = data.reduce((a, b) => a + b.SLSMASTER, 0);
      const totalProj = data.reduce((a, b) => a + b.PROJECT, 0);
      const avgProj = data.length ? data.reduce((a, b) => a + b["%PROJECT"], 0) / data.length : 0;
      const avgFinal = data.length ? data.reduce((a, b) => a + b["%FINALISASIPROJECT"], 0) / data.length : 0;

      const kpiHtml = [
        { title: "Total SLSMASTER", value: totalSLS },
        { title: "Total PROJECT", value: totalProj },
        { title: "Rata-rata %PROJECT", value: avgProj.toFixed(1) + "%" },
        { title: "Rata-rata %FINALISASI", value: avgFinal.toFixed(1) + "%" },
      ].map(k => `
        <div class="bg-white border rounded p-4 shadow">
          <div class="text-sm text-gray-500">${k.title}</div>
          <div class="text-xl font-semibold">${k.value}</div>
        </div>
      `).join("");
      document.getElementById("kpi").innerHTML = kpiHtml;
    }

    function renderChart(data) {
      const grouped = {};
      data.forEach(d => {
        if (!grouped[d.PML]) grouped[d.PML] = { count: 0, sumProj: 0, sumFinal: 0 };
        grouped[d.PML].count++;
        grouped[d.PML].sumProj += d["%PROJECT"];
        grouped[d.PML].sumFinal += d["%FINALISASIPROJECT"];
      });
      const labels = Object.keys(grouped);
      const projVals = labels.map(l => (grouped[l].sumProj / grouped[l].count).toFixed(1));
      const finalVals = labels.map(l => (grouped[l].sumFinal / grouped[l].count).toFixed(1));

      const ctx = document.getElementById("pmlChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: '%PROJECT', data: projVals, backgroundColor: '#3b82f6' },
            { label: '%FINALISASI', data: finalVals, backgroundColor: '#22c55e' }
          ]
        },
        options: { responsive: true, scales: { y: { max: 100, beginAtZero: true } } }
      });
    }

    function getProgressClass(percent) {
      if (percent >= 90) return "bg-green-100";
      if (percent >= 70) return "bg-yellow-100";
      return "bg-red-100";
    }

    function renderTable(data) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = data.map(d => `
        <tr class="border-b">
          <td class="p-2">${d.PML}</td>
          <td class="p-2">${d.PPL}</td>
          <td class="p-2 text-right">${d.SLSMASTER}</td>
          <td class="p-2 text-right">${d.PROJECT}</td>
          <td class="p-2 text-right ${getProgressClass(d["%PROJECT"])}">${d["%PROJECT"].toFixed(1)}%</td>
          <td class="p-2 text-right">${d.FINALISASIPROJECT}</td>
          <td class="p-2 text-right ${getProgressClass(d["%FINALISASIPROJECT"])}">${d["%FINALISASIPROJECT"].toFixed(1)}%</td>
          <td class="p-2 text-right">${d.LANDMARK}</td>
          <td class="p-2 text-right">${d.BATASSLS}</td>
          <td class="p-2 text-right">${d.BATASSEGMEN}</td>
        </tr>
      `).join("");
    }

    fetchData();
  </script>
</body>
</html>
